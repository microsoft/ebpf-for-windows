<?xml version="1.0" encoding="utf-8"?>
<!--
  Copyright (c) eBPF for Windows contributors
  SPDX-License-Identifier: MIT
-->
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(SolutionDir)wdk.props" />
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <Keyword>Win32Proj</Keyword>
    <ProjectGuid>{1EB64C33-FC48-44D0-B7A2-A5D9B229D425}</ProjectGuid>
    <RootNamespace>ebpf_mcp</RootNamespace>
    <TargetName>ebpf_mcp</TargetName>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)'=='Debug'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)'=='NativeOnlyDebug'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)'=='FuzzerDebug'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)'=='Release'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)'=='NativeOnlyRelease'" Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)'=='Debug'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Condition="'$(Configuration)'=='NativeOnlyDebug'" Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Condition="'$(Configuration)'=='FuzzerDebug'" Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)'=='Release'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Condition="'$(Configuration)'=='NativeOnlyRelease'" Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <!-- Common include directories shared by all configurations.
       Modeled on ebpfsvc.vcxproj include paths. -->
  <PropertyGroup>
    <PrevailMcpIncludes>$(SolutionDir)include;$(SolutionDir)ebpfapi;$(SolutionDir)libs\api_common;$(SolutionDir)libs\api;$(SolutionDir)libs\service;$(SolutionDir)libs\shared;$(SolutionDir)libs\shared\user;$(SolutionDir)libs\execution_context;$(SolutionDir)libs\thunk;$(SolutionDir)tools\prevail_mcp\src;$(SolutionDir)external\ebpf-verifier\src\mcp;$(SolutionDir)rpc_interface;$(SolutionDir)external\usersim\cxplat\inc;$(SolutionDir)external\usersim\cxplat\inc\winuser;$(SolutionDir)external\ebpf-verifier\src;$(SolutionDir)external\ebpf-verifier\external;$(SolutionDir)external\ebpf-verifier\external\bpf_conformance\external\elfio;$(SolutionDir)external\ebpf-verifier\external\bpf_conformance\lib\include;$(SolutionDir)external\ebpf-verifier\external\libbtf;$(SolutionDir)external\ebpf-verifier\build\shim;$(SolutionDir)external\ebpf-verifier\build\_deps\gsl-src\include;$(SolutionDir)external\ebpf-verifier\build\packages\boost\lib\native\include;$(SolutionDir)external\ubpf\vm;$(SolutionDir)external\ubpf\vm\inc;$(SolutionDir)resource;$(SolutionDir)tests\libs\util</PrevailMcpIncludes>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)'=='Debug'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)'=='NativeOnlyDebug'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)'=='FuzzerDebug'">
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)'=='Release'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)'=='NativeOnlyRelease'">
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)'=='Debug'">
    <ClCompile>
      <PreprocessorDefinitions>_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <ExceptionHandling>Async</ExceptionHandling>
      <AdditionalIncludeDirectories>$(PrevailMcpIncludes);$(OutDir);%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>DebugFull</GenerateDebugInformation>
      <AdditionalDependencies>mincore.lib;$(FuzzerLibs);%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)'=='NativeOnlyDebug'">
    <ClCompile>
      <PreprocessorDefinitions>_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <ExceptionHandling>Async</ExceptionHandling>
      <AdditionalIncludeDirectories>$(PrevailMcpIncludes);$(OutDir);$(OutDir)..\Debug;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>DebugFull</GenerateDebugInformation>
      <AdditionalDependencies>mincore.lib;$(FuzzerLibs);%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)'=='FuzzerDebug'">
    <ClCompile>
      <PreprocessorDefinitions>_DEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <ExceptionHandling>Async</ExceptionHandling>
      <AdditionalIncludeDirectories>$(PrevailMcpIncludes);$(OutDir);%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <GenerateDebugInformation>DebugFull</GenerateDebugInformation>
      <AdditionalDependencies>mincore.lib;$(FuzzerLibs);%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)'=='Release'">
    <ClCompile>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <PreprocessorDefinitions>NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <ExceptionHandling>Async</ExceptionHandling>
      <AdditionalIncludeDirectories>$(PrevailMcpIncludes);$(OutDir);%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>DebugFull</GenerateDebugInformation>
      <AdditionalDependencies>mincore.lib;$(FuzzerLibs);%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)'=='NativeOnlyRelease'">
    <ClCompile>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <PreprocessorDefinitions>NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <ExceptionHandling>Async</ExceptionHandling>
      <AdditionalIncludeDirectories>$(PrevailMcpIncludes);$(OutDir);$(OutDir)..\Release;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>DebugFull</GenerateDebugInformation>
      <AdditionalDependencies>mincore.lib;$(FuzzerLibs);%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <!-- Core MCP server sources from prevail submodule -->
    <ClCompile Include="..\..\external\ebpf-verifier\src\mcp\mcp_transport.cpp" />
    <ClCompile Include="..\..\external\ebpf-verifier\src\mcp\mcp_server.cpp" />
    <ClCompile Include="..\..\external\ebpf-verifier\src\mcp\analysis_engine.cpp" />
    <ClCompile Include="..\..\external\ebpf-verifier\src\mcp\json_serializers.cpp" />
    <ClCompile Include="..\..\external\ebpf-verifier\src\mcp\tools.cpp" />
    <!-- Windows-specific entry point -->
    <ClCompile Include="src\windows\main.cpp" />
    <!-- Shared source files, same as bpf2c/ebpfapi -->
    <ClCompile Include="..\..\libs\shared\hash.cpp" />
    <!-- Platform thunk provides Platform::DeviceIoControl etc., same pattern as ebpfsvc -->
    <ClCompile Include="..\..\libs\thunk\windows\platform.cpp" />
    <!-- RPC client stubs (compiled into ebpfapi.dll, needed here since we link api.lib directly) -->
    <ClCompile Include="..\..\ebpfapi\rpc_client.cpp" />
  </ItemGroup>
  <ItemGroup>
    <!-- Core headers from prevail submodule -->
    <ClInclude Include="..\..\external\ebpf-verifier\src\mcp\platform_ops.hpp" />
    <ClInclude Include="..\..\external\ebpf-verifier\src\mcp\platform_ops_prevail.hpp" />
    <ClInclude Include="..\..\external\ebpf-verifier\src\mcp\prevail_headers.hpp" />
    <ClInclude Include="..\..\external\ebpf-verifier\src\mcp\mcp_transport.hpp" />
    <ClInclude Include="..\..\external\ebpf-verifier\src\mcp\mcp_server.hpp" />
    <ClInclude Include="..\..\external\ebpf-verifier\src\mcp\analysis_engine.hpp" />
    <ClInclude Include="..\..\external\ebpf-verifier\src\mcp\json_serializers.hpp" />
    <ClInclude Include="..\..\external\ebpf-verifier\src\mcp\tools.hpp" />
    <!-- Windows-specific headers -->
    <ClInclude Include="src\windows\platform_ops_windows.hpp" />
  </ItemGroup>
  <!-- Project references matching ebpfapi.vcxproj dependencies (using api.lib instead of the DLL) -->
  <ItemGroup>
    <ProjectReference Include="..\..\external\ebpf-verifier\build\prevail.vcxproj">
      <Project>{7d5b4e68-c0fa-3f86-9405-f6400219b440}</Project>
    </ProjectReference>
    <ProjectReference Include="..\..\external\ebpf-verifier\build\libbtf\libbtf\libbtf.vcxproj">
      <Project>{CDAF684D-2751-3403-9AC7-6D453187C3C5}</Project>
    </ProjectReference>
    <ProjectReference Include="..\..\libs\elf_spec\elf_spec.vcxproj">
      <Project>{c3d2cd73-bf4c-47df-8808-2a9996124d5b}</Project>
    </ProjectReference>
    <ProjectReference Include="..\..\external\usersim\cxplat\src\cxplat_winuser\cxplat_winuser.vcxproj">
      <Project>{f2ca70ab-af9a-47d1-9da9-94d5ab573ac2}</Project>
    </ProjectReference>
    <ProjectReference Include="..\..\libs\api\api.vcxproj">
      <Project>{c8bf60c3-40a9-43ad-891a-8aa34f1c3a68}</Project>
    </ProjectReference>
    <ProjectReference Include="..\..\libs\api_common\api_common.vcxproj">
      <Project>{e79382b2-fed9-4cd4-9498-dbddd6c46c91}</Project>
    </ProjectReference>
    <ProjectReference Include="..\..\libs\pe-parse\pe-parse.vcxproj">
      <Project>{fe4fea79-bfbb-4822-abcb-0d3beea240a7}</Project>
    </ProjectReference>
    <ProjectReference Include="..\..\libs\shared\user\shared_user.vcxproj">
      <Project>{9388dd45-7941-45d7-b4ff-bc00f550af17}</Project>
    </ProjectReference>
    <ProjectReference Include="..\..\libs\ubpf\user\ubpf_user.vcxproj">
      <Project>{245f0ec7-1ebc-4d68-8b1f-f758ea9196ae}</Project>
    </ProjectReference>
    <ProjectReference Include="..\..\rpc_interface\rpc_interface.vcxproj">
      <Project>{1423245d-0249-40fc-a077-ff7780acfe3f}</Project>
    </ProjectReference>
  </ItemGroup>
  <ItemGroup>
    <None Include="packages.config" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
    <Import Project="$(SolutionDir)packages\nlohmann.json.3.12.0\build\native\nlohmann.json.targets" Condition="Exists('$(SolutionDir)packages\nlohmann.json.3.12.0\build\native\nlohmann.json.targets')" />
  </ImportGroup>
  <Target Name="EnsureNuGetPackageBuildImports" BeforeTargets="PrepareForBuild">
    <PropertyGroup>
      <ErrorText>This project references NuGet package(s) that are missing on this computer. Use NuGet Package Restore to download them.  For more information, see http://go.microsoft.com/fwlink/?LinkID=322105. The missing file is {0}.</ErrorText>
    </PropertyGroup>
    <Error Condition="!Exists('$(SolutionDir)packages\nlohmann.json.3.12.0\build\native\nlohmann.json.targets')" Text="$([System.String]::Format('$(ErrorText)', '$(SolutionDir)packages\nlohmann.json.3.12.0\build\native\nlohmann.json.targets'))" />
  </Target>
</Project>
