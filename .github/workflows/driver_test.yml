# Copyright (c) Microsoft Corporation
# SPDX-License-Identifier: MIT

# This workflow depends on self-hosted runners. See the following document for details:
# https://github.com/microsoft/ebpf-for-windows/blob/master/docs/SelfHostedRunnerSetup.md
#
# For documentation on the syntax of this file, see
# https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions
name: Kernel_Test

# Run this work flow when the "MSBuild workflow completes"
on:
  workflow_run:
    workflows: ["MSBuild"]
    types:
      - completed

jobs:
  test:
    strategy:
      matrix:
        configurations: [Debug, Release]

    runs-on: [windows, self-hosted]
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
    - name: Download workflow artifact
      uses: dawidd6/action-download-artifact@v2.14.1
      with:
        workflow: build.yml
        workflow_conclusion: success
        commit: ${{ github.event.workflow_run.head_commit.id }}
        name: Build x64 ${{ matrix.configurations }}
        path: ${{ github.workspace }}

    - name: Install eBPF
      working-directory: ${{ github.workspace }}
      run: ./install-ebpf.bat

    - name: Run Unit Tests
      working-directory: ./${{env.BUILD_PLATFORM}}/${{env.BUILD_CONFIGURATION}}
      run: ./unit_tests.exe -s

    - name: Run Ebpf Client Tests
      working-directory: ./${{env.BUILD_PLATFORM}}/${{env.BUILD_CONFIGURATION}}
      run: |
        $env:install=0
        .\ebpf_client.exe -s

    - name: Run Ebpf API Tests
      working-directory: ./${{env.BUILD_PLATFORM}}/${{env.BUILD_CONFIGURATION}}
      run: |
        $env:install=0
        .\api_test.exe -s

    - name: Run Ebpf Sample Extension Tests
      working-directory: ./${{env.BUILD_PLATFORM}}/${{env.BUILD_CONFIGURATION}}
      run: |
        $env:install=0
        .\sample_ext_app.exe -s

    - name: Uninstall eBPF
      working-directory: ${{ github.workspace }}
      run: ./uninstall-ebpf.bat
