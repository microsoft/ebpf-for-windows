# Copyright (c) eBPF for Windows contributors
# SPDX-License-Identifier: MIT

---
name: TLA+ Epoch Model

on:
  pull_request:
    paths:
      - 'models/epoch/**'
      - 'libs/runtime/ebpf_epoch.c'
      - 'libs/runtime/ebpf_epoch.h'
      - '.github/workflows/tla-plus-epoch.yml'
  push:
    branches:
      - main
    paths:
      - 'models/epoch/**'
      - 'libs/runtime/ebpf_epoch.c'
      - 'libs/runtime/ebpf_epoch.h'
      - '.github/workflows/tla-plus-epoch.yml'

permissions:
  contents: read

jobs:
  tlc:
    name: TLC model check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '21'

      - name: Download tla2tools.jar
        run: |
          curl -fsSL -o tla2tools.jar \
            https://github.com/tlaplus/tlaplus/releases/download/v1.7.4/tla2tools.jar

      - name: TLC fixed config must pass
        run: |
          java -XX:+UseParallelGC -cp tla2tools.jar tlc2.TLC -workers auto \
            -config models/epoch/EpochModel.cfg \
            models/epoch/EpochModel.tla

      - name: TLC buggy config must fail (find counterexample)
        shell: bash
        run: |
          set +e
          java -XX:+UseParallelGC -cp tla2tools.jar tlc2.TLC -workers auto \
            -config models/epoch/EpochModel_buggy.cfg \
            models/epoch/EpochModel.tla \
            > tlc-buggy.out 2>&1
          status=$?
          cat tlc-buggy.out

          if [ "$status" -eq 0 ]; then
            echo "Buggy model unexpectedly passed"
            exit 1
          fi

          if ! grep -q "Invariant Safety is violated" tlc-buggy.out; then
            echo "Buggy model failed, but did not report a Safety invariant violation"
            exit 1
          fi
